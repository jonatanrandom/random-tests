<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller</title>
<style>
  body { font-family:sans-serif; text-align:center; padding:2em; }
  input { font-size:1.2em; padding:0.3em; width:80%; max-width:300px; }
  button { font-size:1.2em; padding:0.4em 1em; margin-top:0.5em; }
  #status { margin-top:1em; color:green; }
</style>
</head>
<body>
<h2>controller</h2>
<input id="peerId" placeholder="Viewer ID">
<br>
<button id="connectBtn">Connect</button>
<br>
<button id="modeBtn">Change Mode</button>
<div id="status"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer = new Peer();
let conn;
let connected = false;
let currentMode = 'ungather'; // track current viewer mode

const status = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const peerInput = document.getElementById('peerId');
const modeBtn = document.getElementById('modeBtn');
modeBtn.disabled = true;

connectBtn.onclick = () => {
  const id = peerInput.value.trim();
  if (!id) {
    alert("Please enter the viewer ID");
    return;
  }
  conn = peer.connect(id);
  conn.on('open', () => {
    connected = true;
    status.textContent = 'Connected!';
    modeBtn.disabled = false;
    enableTiltControl();
  });
  conn.on('error', err => {
    status.textContent = 'Connection failed: ' + err;
  });
};

// Manual override button
modeBtn.onclick = () => {
  if (connected && conn?.open) {
    const newMode = currentMode === 'gather' ? 'ungather' : 'gather';
    conn.send({ type: 'toggleGather', state: newMode });
    currentMode = newMode;
    status.textContent = 'Mode manually toggled to ' + newMode;
  }
};

function enableTiltControl() {
  // Request iOS permission if necessary
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          window.addEventListener('deviceorientation', handleTilt);
        } else {
          alert('Motion permission denied.');
        }
      })
      .catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleTilt);
  }
}

function handleTilt(e) {
  if (!connected || !conn?.open) return;

  const beta = e.beta || 0; // front-back tilt, range ~[-180,180]
  const isPickedUp = Math.abs(beta) > 30; // threshold angle

  const desiredMode = isPickedUp ? 'gather' : 'ungather';
  if (desiredMode !== currentMode) {
    currentMode = desiredMode;
    conn.send({ type: 'toggleGather', state: desiredMode });
    status.textContent = `Tilt detected: switched to ${desiredMode}`;
  }
}
</script>
</body>
</html>