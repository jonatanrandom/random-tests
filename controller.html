<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller</title>
<style>
  body { font-family:sans-serif; text-align:center; padding:2em; }
  input { font-size:1.2em; padding:0.3em; width:80%; max-width:300px; }
  button { font-size:1.2em; padding:0.4em 1em; margin-top:0.5em; }
  #status { margin-top:1em; color:green; }
</style>
</head>
<body>
<h2>controller</h2>
<input id="peerId" placeholder="Viewer ID">
<br>
<button id="connectBtn">Connect</button>
<div id="status"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer = new Peer();
let conn;
let connected = false;
let lastSpikeTime = 0;

const status = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const peerInput = document.getElementById('peerId');

connectBtn.onclick = () => {
  const id = peerInput.value.trim();
  if (!id) {
    alert("Please enter the viewer ID");
    return;
  }
  conn = peer.connect(id);
  conn.on('open', () => {
    connected = true;
    status.textContent = 'Connected!';
    enableGyro();
  });
  conn.on('error', err => {
    status.textContent = 'Connection failed: ' + err;
  });
};

function enableGyro() {
  // iOS requires user permission for motion sensors
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          window.addEventListener('deviceorientation', handleTilt);
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert('Motion permission denied.');
        }
      })
      .catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleTilt);
    window.addEventListener('devicemotion', handleMotion);
  }
}

function handleTilt(e) {
  if (!connected || !conn?.open) return;
  const gamma = e.gamma || 0; // left-right tilt
  const beta = e.beta || 0;   // front-back tilt
  const x = Math.max(-30, Math.min(30, gamma)) * 5;
  const y = Math.max(-30, Math.min(30, beta)) * 5;
  conn.send({ type: 'tilt', x, y });
}

function handleMotion(e) {
  if (!connected || !conn?.open) return;
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;
  const x = acc.x || 0;
  const y = acc.y || 0;
  const z = acc.z || 0;
  const magnitude = Math.sqrt(x*x + y*y + z*z);
  const now = Date.now();
  if (magnitude > 25 && now - lastSpikeTime > 3000) {
    lastSpikeTime = now;
    conn.send({ type: 'spike' });
  }
}
</script>
</body>
</html>