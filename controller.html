<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller</title>
<style>
  body { font-family:sans-serif; text-align:center; padding:2em; }
  input { font-size:1.2em; padding:0.3em; width:80%; max-width:300px; }
  button { font-size:1.2em; padding:0.4em 1em; margin-top:0.5em; }
  #status { margin-top:1em; color:green; }
</style>
</head>
<body>
<h2>controller</h2>
<input id="peerId" placeholder="Viewer ID">
<br>
<button id="connectBtn">Connect</button>
<br>
<button id="modeBtn">Change Mode</button>
<div id="status"></div>
<div id="tiltDisplay">Motion: 0.00 m/s²</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer = new Peer();
let conn;
let connected = false;
let currentMode = 'ungather'; // track current viewer mode

const status = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const peerInput = document.getElementById('peerId');
const modeBtn = document.getElementById('modeBtn');
modeBtn.disabled = true;

connectBtn.onclick = () => {
  const id = peerInput.value.trim();
  if (!id) {
    alert("Please enter the viewer ID");
    return;
  }
  conn = peer.connect(id);
  conn.on('open', () => {
    connected = true;
    status.textContent = 'Connected!';
    modeBtn.disabled = false;
    enableTiltControl();
  });
  conn.on('error', err => {
    status.textContent = 'Connection failed: ' + err;
  });
};

// Manual override button
modeBtn.onclick = () => {
  if (connected && conn?.open) {
    const newMode = currentMode === 'gather' ? 'ungather' : 'gather';
    conn.send({ type: 'toggleGather', state: newMode });
    currentMode = newMode;
    status.textContent = 'Mode manually toggled to ' + newMode;
  }
};

function enableTiltControl() {
  // Request iOS permission if necessary
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert('Motion permission denied.');
        }
      })
      .catch(console.error);
  } else {
    window.addEventListener('devicemotion', handleMotion);
  }
}

let stillTimer = null;
let moving = false;

function handleMotion(e) {
  if (!connected || !conn?.open) return;

  const linearAcc = e.acceleration;
  const gravityAcc = e.accelerationIncludingGravity;
  if (!linearAcc || !gravityAcc) return;

  // Compute total linear acceleration magnitude (without gravity)
  const total = Math.sqrt(linearAcc.x * linearAcc.x + linearAcc.y * linearAcc.y + linearAcc.z * linearAcc.z);
  const threshold = 10.0; // sensitivity threshold (m/s²)

  document.getElementById('tiltDisplay').textContent = `Motion: ${total.toFixed(2)} m/s²`;

  const isMoving = total > threshold;

  if (isMoving) {
    moving = true;
    if (stillTimer) {
      clearTimeout(stillTimer);
      stillTimer = null;
    }
    if (currentMode !== 'gather') {
      currentMode = 'gather';
      conn.send({ type: 'toggleGather', state: 'gather' });
      status.textContent = 'Motion detected: switched to gather';
    }
  } else {
    if (!stillTimer) {
      // Wait for a short period of stillness before switching back
      stillTimer = setTimeout(() => {
        moving = false;

        // Estimate tilt angle: 0° = lying flat on its back
        const angle = Math.abs(Math.atan2(gravityAcc.x, Math.sqrt(gravityAcc.y * gravityAcc.y + gravityAcc.z * gravityAcc.z)) * (180 / Math.PI));

        if (angle < 5 && currentMode !== 'ungather') {
          currentMode = 'ungather';
          conn.send({ type: 'toggleGather', state: 'ungather' });
          status.textContent = `Phone is still and flat (angle ${angle.toFixed(1)}°): switched to ungather`;
        }
      }, 300); // 0.3s stillness before switching back
    }
  }
}
</script>
</body>
</html>