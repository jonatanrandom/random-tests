<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller</title>
<style>
  body { font-family:sans-serif; text-align:center; padding:2em; }
  input { font-size:1.2em; padding:0.3em; width:80%; max-width:300px; }
  button { font-size:1.2em; padding:0.4em 1em; margin-top:0.5em; }
  #status { margin-top:1em; color:green; }
</style>
</head>
<body>
<h2>controller</h2>
<input id="peerId" placeholder="Viewer ID">
<br>
<button id="connectBtn">Connect</button>
<div id="status"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let uniqueId = `controller-${Math.random().toString(36).substr(2, 9)}`;
let peer = new Peer(uniqueId);
let conn;
let connected = false;

const status = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const peerInput = document.getElementById('peerId');

connectBtn.onclick = () => {
conn = peer.connect(peerInput.value.trim());
  conn.on('open', () => {
    connected = true;
    status.textContent = 'Connected!';
    enableSensors();
  });
  conn.on('error', err => {
    status.textContent = 'Connection failed: ' + err;
  });
};

function enableSensors() {
  // iOS motion permission
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          window.addEventListener('deviceorientation', handleTilt);
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert('Motion permission denied.');
        }
      })
      .catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleTilt);
    window.addEventListener('devicemotion', handleMotion);
  }
}

function handleTilt(e) {
  if (!connected || !conn?.open) return;
  const gamma = e.gamma || 0;
  const beta = e.beta || 0;
  const x = Math.max(-30, Math.min(30, gamma)) * 5;
  const y = Math.max(-30, Math.min(30, beta)) * 5;
  conn.send({ type: 'tilt', x, y });
}

// Detect spikes in acceleration
let lastSpikeTime = 0;
let smoothMag = 0;

function handleMotion(e) {
  if (!connected || !conn?.open) return;
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
  smoothMag = 0.8 * smoothMag + 0.2 * mag; // low-pass filter to smooth noise
  const now = Date.now();

  // Trigger only on strong motion
  if (smoothMag > 18 && now - lastSpikeTime > 1500) {
    lastSpikeTime = now;
    conn.send({ type: 'spike' });
  }
}
</script>
</body>
</html>